<!DOCTYPE html>
<html lang="zh">
<head>
<!-- head--->
    
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
    <meta charset="UTF-8">
	<meta name="keywords" content="IT,Linux,Docker,K8S,网络, Java, Python, XHTML, JavaScript">
	<meta name="keywords" content="IT 民工,IT Worker">
	<meta name="description" content="IT技术分享">
    <!-- libs css-->
    <link rel="stylesheet" href="/_assets/css/bootstrap.css">
    <link rel="stylesheet" href="/_assets/css/tool.css">
    <!-- libs js -->
    <script src="/_assets/js/jquery-1.8.2.min.js"></script>
    <script src="/_assets/js/jquery.ba-hashchange.js"></script>
    <!--<script src="/_assets/js/onePage.js"></script>-->
    <script src="/_assets/js/tool.js"></script>
    <script src="/_assets/js/base.js"></script>
    <!-- style -->
    <link rel="stylesheet" href="/_assets/style.css">
    <link rel="stylesheet" href="/_assets/css/media.css">
	<meta name="keywords" content="00004.lsof用法">
    <title>00004.lsof用法-IT 民工</title>
</head>
<body>
<!-- 头部 -->
<div class="header">
    <div class="container header-all phone">
        <div class="logo"><a href="/index"><img src="/_assets/images/logo.png"/></a></div>
        <div class="phone-show" id="phone-show">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <ul class="nav" id="header-nav">
		
		
		
          <li><a href="/index"><i class="iconfont">&#xe6cb;</i>首页</a></li>
        
		
          <li><a href="/archives"><i class="iconfont">&#xe690;</i>归档</a></li>
        
		
          <li><a href="/about"><i class="iconfont">&#xe69e;</i>关于</a></li>
        
		 
		
          <li><a href="/rss.xml"><i class="iconfont">&#xe6cb;</i>RSS</a></li>
          
	           
        </ul>
    </div>
</div>
<t></t>

<!-- 内容 -->
<div class="content container" data-content>
    <!-- 一级 -->
    <ul class="list row bj-white" id="list-1">
        <li class="title">
            <i class="iconfont c-hong">&#xe940;</i>热门推介<label>欢迎访问IT民工的网站！</label>
        </li>
        <div>
            <li class="cont-req">
                <a class="t1_pick"><img src="/_assets/images/header-img-1.jpg"/></a>
				<h3><a href="javascript:;">美丽的向日葵</a></h3>

            </li>
            <li class="cont-req">
                <a class="t1_pick"><img src="/_assets/images/header-img-2.jpg"/></a>
				<h3><a href="javascript:;">枫叶山</a></h3>

            </li>
            <li class="cont-req">
                <a class="t1_pick"><img src="/_assets/images/header-img-3.jpg"/></a>
				<h3><a href="javascript:;">大峡谷</a></h3>

            </li>
            <li class="cont-req">
                <a class="t1_pick"><img src="/_assets/images/header-img-4.jpg"/></a>
				<h3><a href="javascript:;">吊桥</a></h3>
            </li>
            <li class="cont-req">
                <a class="t1_pick"><img src="/_assets/images/header-img-5.jpg"/></a>
				<h3><a href="javascript:;">花朵</a></h3>
            </li>
        </div>
    </ul>

    <!-- 二级 -->
    <div class="love2" >

        <div class="left">
            <!-- 文章主体 -->
            <div class="contents">
                <div class="title">00004.lsof用法</div>
                <div class="title_t">时间：2024-01-18 08:55丨编辑：<a href="/index">IT民工</a></div>
                <div class="ner">
                  <p>lsof（list open files）是一个查看当前系统文件的工具。在linux环境下，任何事物都以文件的形式存在，用户通过文件不仅可以访问常规数据，还可以访问网络连接和硬件；如传输控制协议 (TCP) 和用户数据报协议 (UDP)套接字等，系统在后台都为该应用程序分配了一个文件描述符，该文件描述符提供了大量关于此应用程序的信息。本期，ISEC实验室的刘老师为大家详解lsof的用法。</p>
<p>一、命令参数</p>
<p>-a：列出打开文件存在的进程；</p>
<p>-c&lt;进程名&gt;：列出指定进程所打开的文件；</p>
<p>-g：列出GID号进程详情；</p>
<p>-d&lt;文件号&gt;：列出占用该文件号的进程；</p>
<p>+d&lt;目录&gt;：列出目录下被打开的文件；</p>
<p>+D&lt;目录&gt;：递归列出目录下被打开的文件；</p>
<p>-n&lt;目录&gt;：列出使用NFS的文件；</p>
<p>-i&lt;条件&gt;：列出符合条件的进程(4、6、协议、:端口、 @ip )；</p>
<p>-p&lt;进程号&gt;：列出指定进程号所打开的文件；</p>
<p>-u：列出UID号进程详情；</p>
<p>-h：显示帮助信息；</p>
<p>-v：显示版本信息。</p>
<p>二、实例讲解</p>
<p><img src="/_resources/75610d82c3d44613849c5f7d741c24ae.png" /></p>
<p>1、lsof输出各列信息的意义，如下：</p>
<p>COMMAND：进程的名称；</p>
<p>PID：进程标识符；</p>
<p>PPID：父进程标识符(需要指定-R参数)；</p>
<p>USER：进程所有者；</p>
<p>PGID：进程所属组；</p>
<p>FD：文件描述符，应用程序通过文件描述符识别该文件。</p>
<p>2、文件描述符列表：</p>
<p>①. cwd：表示current work dirctory，即：应用程序的当前工作目录，这是该应用程序启动的目录，除非它本身对这个目录进行更改；</p>
<p>②. txt：该类型的文件是程序代码，如应用程序二进制文件本身或共享库，如上列表中显示的 /sbin/init 程序；</p>
<p>③. lnn：library references (AIX)；</p>
<p>④. er：FD information error (see NAME column)；</p>
<p>⑤. jld：jail directory (FreeBSD)；</p>
<p>⑥. ltx：shared library text (code and data)；</p>
<p>⑦. mxx ：hex memory-mapped type number xx.</p>
<p>⑧. m86：DOS Merge mapped file；</p>
<p>⑨. mem：memory-mapped file；</p>
<p>⑩. mmap：memory-mapped device；</p>
<p>. pd：parent directory；</p>
<p>. rtd：root directory；</p>
<p>. tr：kernel trace file (OpenBSD)；</p>
<p>. v86 VP/ix mapped file；</p>
<p>. 0：表示标准输出；</p>
<p>. 1：表示标准输入；</p>
<p>. 2：表示标准错误。</p>
<p>3、一般在标准输出、标准错误、标准输入后，还跟着文件状态模式：</p>
<p>①.u：表示该文件被打开并处于读取/写入模式；</p>
<p>②.r：表示该文件被打开并处于只读模式；</p>
<p>③.w：表示该文件被打开并处于只写模式；</p>
<p>④.空格：表示该文件的状态模式为unknow，且没有锁定；</p>
<p>⑤.-：表示该文件的状态模式为unknow，且被锁定。</p>
<p>4、同时在文件状态模式后面，还跟着相关的锁：</p>
<p>①. N：for a Solaris NFS lock of unknown type；</p>
<p>②. r：for read lock on part of the file；</p>
<p>③. R：for a read lock on the entire file；</p>
<p>④. w：for a write lock on part of the file；(文件的部分写锁)</p>
<p>⑤. W：for a write lock on the entire file；(整个文件的写锁)</p>
<p>⑥. u：for a read and write lock of any length；</p>
<p>⑦. U：for a lock of unknown type；</p>
<p>⑧. x：for an SCO OpenServer Xenix lock on part of the file；</p>
<p>⑨. X：for an SCO OpenServer Xenix lock on the entire file；</p>
<p>⑩. space：if there is no lock。</p>
<p>5、文件类型</p>
<p>①. DIR：表示目录；</p>
<p>②. CHR：表示字符类型；</p>
<p>③. BLK：块设备类型；</p>
<p>④. UNIX：UNIX 域套接字；</p>
<p>⑤. FIFO：先进先出 (FIFO) 队列；</p>
<p>⑥. IPv4：网际协议 (IP) 套接字；</p>
<p>⑦. DEVICE：指定磁盘的名称；</p>
<p>⑧. SIZE：文件的大小；</p>
<p>⑨. NODE：索引节点(文件在磁盘上的标识)；</p>
<p>⑩. NAME：打开文件的确切名称。</p>
<p>三、可打开文件</p>
<p>①. 普通文件；</p>
<p>②. 目录；</p>
<p>③. 网络文件系统的文件；</p>
<p>④. 字符或设备文件；</p>
<p>⑤. (函数)共享库；</p>
<p>⑥. 管道，命名管道；</p>
<p>⑦. 符号链接；</p>
<p>⑧. 网络文件(例如：NFS file、网络socket，unix域名socket)；</p>
<p>⑨. 其它类型的文件等。</p>
<p>四、常规用法</p>
<p>lsof 常被用来查找应用程序打开的文件名称和数目，系统管理员可能想尝试找出某个特定应用程序将日志数据记录到何处，或者正在跟踪某个问题。接下来，我们来看看是如何操作的：</p>
<p>1、进程篇</p>
<p>(1)、查看由登陆用户启动而非系统启动的进程：</p>
<p>命令： lsof /dev/pts0<br />
<img src="/_resources/2d4b712ed5fd4fdfbebc428d23460617.png" /></p>
<p>a. /dev/pts是远程登陆(telnet,ssh等)后创建的控制台设备文件所在的目录；</p>
<p>b. 第一个用户登陆，console的设备文件为/dev/pts/0，第二个为/dev/pts/1，以此类推；</p>
<p>c. 通过查看/dev/pts下的进程，我们将可以了解到由登陆用户启动而非系统启动的进程有哪些。</p>
<p>(2)、查看文件，设备被哪些进程占用：</p>
<p>命令：lsof /dev/tty1</p>
<p><img src="/_resources/82de2d48d0f5415687cb2f321bafe71a.png" /></p>
<p>a. /dev/tty就是当前进程的控制终端的设备特殊文件；</p>
<p>b. 通过查看/dev/tty下文件可以知道文件、设备的进程占用情况。</p>
<p>(3)、指定进程号，可以查看该进程打开的文件：</p>
<p>命令：lsof -p 27358<br />
<img src="/_resources/a7d25645610741069caba7553c709fe2.png" /><br />
a. 通过加入参数-p，我们可以指定一个PID，然后查看该进程下打开的文件。</p>
<p>b. 本例我们查看的是nginx下打开的相关文件。</p>
<p>2、文件篇</p>
<p>(1)、查看指定程序打开的文件</p>
<p>命令：lsof -c sshd<br />
<img src="/_resources/fd4391ae7e584c098bc1deaa5236422e.png" /><br />
通过参数-c可以列出指定进程所打开的文件情况，以上是我们打开sshd下被打开文件的情况。</p>
<p>(2)、查看指定用户打开的文件</p>
<p>命令：lsof -u root | more</p>
<p><img src="/_resources/f7b13316c2a241d7a0038417dcf0c129.png" /></p>
<p>通过参数-u查看root用户下存在的文件情况，由于root下显示内容较多，可以利用more来限制，进行分页查看。</p>
<p>(3)、查看指定目录下被打开的文件</p>
<p>命令：lsof +D /home/ 或lsof +d /home/</p>
<p><img src="/_resources/8acadd009f97488684321d30eecb251c.png" /></p>
<p>参数+D为递归列出/home/下被打开的文件，参数+d为列出/home/下被打开的文件。</p>
<p>3、网络篇</p>
<p>(1)、查看所有网络连接</p>
<p>命令：lsof -i 和 lsof -i@127.0.0.1　　<br />
<img src="/_resources/3d8ee1ed8fad410ab36f76600d9f58de.png" /><br />
<img src="/_resources/e59736e9384f4b5d9102983235ca593b.png" /></p>
<p>通过参数-i查看网络连接的情况，包括连接的ip、端口等；以及一些服务的连接情况，例如：sshd等。也可以通过指定ip查看该ip的网络连接情况。</p>
<p>(2)、查看端口连接情况</p>
<p>命令：lsof -i :22<br />
<img src="/_resources/3bc95b57a05e4694b481513b8e7f1333.png" /></p>
<p>通过参数-i:端口可以查看端口的占用情况，-i参数还有查看协议，ip的连接情况等。</p>
<p>4、综合篇</p>
<p>(1)、查看指定进程打开的网络连接</p>
<p>命令：lsof -i -a -p 1535</p>
<p><img src="/_resources/a287934cd706491284fefcac2f726b9a.png" /></p>
<p>使用了参数-i、-a、-p等，-i查看网络连接情况，-a查看存在的进程，-p指定进程。</p>
<p>(2)、查看指定状态的网络连接</p>
<p>命令：lsof -n -P -i TCP -s TCP:ESTABLISHED</p>
<p><img src="/_resources/4a1d814e9a744a8eaa5332dc138ccb58.png" /></p>
<p>参数解释： -n:no host names, -P:no port names,-i TCP指定协议，-s指定协议状态；通过多个参数我们可以清晰的查看网络连接情况、协议连接情况等。</p>
<p>五、恢复被删除的日志</p>
<p>Linux的系统日志默认保存在/var/log下<br />
<img src="/_resources/b140ba0f5c8f447bb2857cb38b8c6506.png" /></p>
<p>当Linux系统被入侵后，很多入侵者经常会删除系统中的各种日志，包括Web的access和error日志、last日志、messages日志、secure日志等，阻碍应急响应和取证调查，比如rm -rf /var/log。</p>
<p><img src="/_resources/03d4adef27be4b3da9e56c6f6fb2a6b2.png" /></p>
<p>遇到这种情况，不要关闭或者重启服务器系统，也不要关闭或重启相关服务或者进程，如：恢复apache的访问日志/var/log/httpd/access_log时，不能关闭或者重启服务器系统，也不能重启httpd服务。</p>
<p>假设我们要恢复被删除的messages日志和secure日志：</p>
<p>1.首先通过losf命令找到使用messages文件的进程的PID和messages文件的FD(文件描述符)；<br />
<img src="/_resources/34f002b904f14f88a1e2578cf872da5b.png" /></p>
<p>从上面命令输出可以看到，这个打开/var/log/messages文件的进程的PID是815，文件/var/log/messages的FD(文件描述符)是4，状态为deleted，标记被删除，但其实该文件并没有从磁盘中删除。</p>
<p>2.如果删除的文件还存在操作的进程，数据将可能被找回，可以在/proc/815/fd/4找到被删除的/var/log/messages文件；</p>
<p><img src="/_resources/4527d233a84f4335a921a32883cea4ee.png" /></p>
<p><img src="/_resources/3c90506ddfc34a14b821daa48e2299c2.png" /></p>
<p>3.恢复被删除的/var/log/secure文件；</p>
<p><img src="/_resources/3ca870a5bc334972b09e2da7d27a5c89.png" /></p>
<p>在Linux系统中删除了一个文件，只要进程还在对文件进行操作，就可能还存在一个inode的引用：/proc/进程号/fd/文件描述符，只要知道当前打开文件的进程pid和文件描述符fd，即可利用lsof命令还原出被删除的文件。</p>
<p>六、总 结</p>
<p>Linux大量使用了文件，作为系统管理员，lsof 允许用户对核心内存进行查看，以找出系统当前如何使用这些文件。lsof的简单用法可以告诉用户哪些进程打开了哪些文件，以及哪些文件由哪些进程打开。</p>
<p>在收集关于应用程序工作情况的信息时，或在进行某些可能损坏数据的操作前，要确保文件未被使用，这一点特别重要。lsof 更高级的用法可以帮助用户查找删除的文件，并获得关于网络连接的信息。lsof 是一个功能强大的工具，它几乎可以用于任何地方。</p>

                </div>
                <div class="label"> 转载请注明出处！--- IT民工 </div>
                <div class="next">
                    <a href="javascript:;">
						</a>
                </div>
            </div>           
        </div>
	<!----侧边栏 --->
	        <div class="right" id="list-right">
            <!-- 关于我 -->
            <div class="thisMe">
                <div class="touPick">
				<img src="/_assets/images/aboutme.jpg" alt="图片走丢了" title="IT民工"></div>
				<ul>
                    <li><b class="font-size:16px;">IT民工</b></li>
                </ul>
                <ul>
                    <li><a href="/index" style="text-decoration:none;" title="主页" class="iconfont">&#xe619;</a></li>
                    <li><a target="_blank" href="mailto:dliangliang@cock.li" title="联系我" style="text-decoration:none;" class="iconfont">&#xe667;</a></li>
                    <li><a href="/about" style="text-decoration:none;" title="关于我" class="iconfont">&#xe645;</a></li>
                </ul>
            </div>
            <!-- 建站史 -->
            <div class="ku">
                <div class="title">建站史</div>
                <div class="shus">
                    <div class="line"></div>
                    <div class="shus-cont">
                        <a>Joplin</a><br>
                        <a>MarkDown</a><br>
                        <a>Pages Publisher</a><br>
                        <a>GitHub Pages</a><br>
                        <a>Cloudflare Pages</a><br>
                        <a>Vercel Project</a><br>
                        <a href="javascript:;" class="href-all">查看全部</a>
                    </div>
                </div>
            </div>
   
            <!-- 标签云 -->
            <div class="labels" id="labels">
                <div class="title">标签云</div>
                <a>打工狗</a>
                <a>代码奴</a>
                <a>金融嗜好</a>
                <a>X瘾患者</a>
                <a>偶尔撸B</a>
                <a>精分患者</a>
                <a>软肋不少</a>
                <a>喜历史</a>
            </div>
            <!-- 友情链接 -->
            <div class="ku">
                <div class="title">左邻右舍</div>
                <div class="neighbor">
                    <a target="_blank" href="https://www.zhihu.com/people/economicsshare" title="知乎：巴甫洛夫的实验">知乎：巴甫洛夫的实验</a>
                    <a target="_blank" href="https://space.bilibili.com/18059632" title="B站：巴甫洛夫的实验">B站：巴甫洛夫的实验</a>
                    <a target="_blank" href="https://author.baidu.com/home?from=bjh_article&app_id=1790832269223398" title="百家号：巴甫洛夫的实验">百家号：巴甫洛夫的实验</a>                  
                </div>
            </div>
        </div>

    </div>
</div>
<!-- 底部 -->
<div class="footer">
    Design by <a href="#">IT民工</a>
    <br>&copy; <script> document.write(new Date().getFullYear()); </script> <a href="#">IT 民工</a>
</div>

<!-- 侧边栏 -->

<div class="ce">
    <a class="ceL" href="#" title="返回顶部"><i class="iconfont top">&#xe65b;</i></a>
</div>


</body>
</html>
